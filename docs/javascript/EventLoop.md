---
title: Event Loop
---

# Event Loop
`Event Loop` 主要指的是 **任务栈**，**宏任务** 与 **微任务**（JS线程），**同步任务** 与 **异步任务**， **线程** 与 **进程**。

JS是一门 **单线程** 的语言。浏览器提供了一些 JS 引擎不具备的功能：**Web API**。它包括 `DOM API`，`setTimeout`，`HTTP`请求 等等。这些功能都可以帮助我们处理 **异步、非阻塞** 的操作。

![Event Loop](./images/eventloop2.png)

## 执行上下文
执行上下文是当前正在执行的 **“代码环境”**。执行上下文有两个阶段：**编译和执行**。

### 编译
在此阶段，JS 引擎获取所有**函数声明**并将其提升到其作用域的**顶部**，以便我们稍后可以引用它们并获取所有变量声明（使用var关键字进行声明），还会为它们提供默认值： `undefined`。

### 执行
在这个阶段中，它将值赋给之前提升的变量，并执行或调用函数(对象中的方法)。

### 类型
- `全局执行上下文`：这是默认或者说基础的上下文，任何不在函数内部的代码都在全局上下文中。它会执行两件事：创建一个全局的 window 对象（浏览器的情况下），并且设置 this 的值等于这个全局对象。一个程序中只会有一个全局执行上下文。
- `函数执行上下文`：每当一个函数被调用时, 都会为该函数创建一个新的上下文。每个函数都有它自己的执行上下文，不过是在函数被调用时创建的。函数上下文可以有任意多个。每当一个新的执行上下文被创建，它会按定义的顺序（将在后文讨论）执行一系列步骤。
- ~~`Eval函数执行上下文`~~

[JavaScript系列之执行上下文和执行栈 - 知乎](https://zhuanlan.zhihu.com/p/68799915)

## 执行栈【任务栈、调用栈】
- 当 JavaScript 引擎第一次遇到你的脚本时，它会创建一个全局的执行上下文并且压入当前执行栈。每当引擎遇到一个函数调用，它会为该函数创建一个新的执行上下文并压入栈的顶部。
- 引擎会执行那些执行上下文位于栈顶的函数。当该函数执行结束时，执行上下文从栈中弹出，控制流程到达当前栈中的下一个上下文。

**执行栈**【call stack】是一个存储函数调用的栈结构，遵循 **后进先出**【Last In, First Out. 即 LIFO】的原则，后执行的函数会先弹出栈。

![https://pic4.zhimg.com/v2-64d2b205834d6efb56bcd506587df523_b.webp](https://pic4.zhimg.com/v2-64d2b205834d6efb56bcd506587df523_b.webp)

首先全局上下文进入函数调用栈，执行 **同步代码**。执行完同步代码后，查询任务队列里是否由 **异步代码** 需要执行。执行所有微任务，微任务执行完毕后。循环再次从宏任务开始，从任务队列中拿出一个执行，一直循环下去。

## 任务队列
在 Web API 中，一个定时器已经创建，它将会等待 1000 ms，当时间到后，这个箭头函数并不会立即被调用栈执行，它会被添加到一个队列中，我们暂且称之为 **任务队列** （原文中叫 Callback Queue）。

![https://pic1.zhimg.com/v2-43b3a252357af1afe3b704375a6374fc_b.webp](https://pic1.zhimg.com/v2-43b3a252357af1afe3b704375a6374fc_b.webp)

## Event Loop
如果 **调用栈** 是一个银行窗口，**任务队列** 中的回调函数是一个个排队办业务的人，那么 **Event Loop** 就是叫号系统！Event Loop 的唯一任务就是 **连接任务队列和调用栈**。

![https://pic1.zhimg.com/v2-ed978011aa34f83bb9bd04be07266388_b.webp](https://pic1.zhimg.com/v2-ed978011aa34f83bb9bd04be07266388_b.webp)

它不停检查 **调用栈** 中是否有任务需要执行，如果没有，就检查 **任务队列**，从中弹出一个任务，放入 **调用栈** 中，如此往复循环。

## 进程、线程
### 进程和线程的区别，js单线程带来的好处？
**进程**就是执行中的一个程序，是操作资源分配的最小单位。**线程**是进程中执行的一个任务，是程序执行的最小单位。

**一个进程由多个线程组成**。进程间相互独立，一个进程下的多个线程共享资源。打开一个不同地址的游览器tab就是一个进程，里面由渲染线程，JS引擎线程，HTTP请求线程。

## 宏任务和微任务

### 宏任务
宏任务：当前调用栈执行的任务（主代码快【同步任务】，定时器等等【异步任务】）。事件放在`callback queue`中，由事件触发线程维护。包括script ， setTimeout ，setInterval ，setImmediate ，I/O ，UI rendering

### 微任务
微任务：宏任务执行完，在下一个宏任务执行之前执行的任务（可以理解为回调事件，promise.then，proness.nextTick等等）。事件放在微任务队列，有 `javascript` 引擎线程维护。
包括process.nextTick ，promise ，MutationObserver

![宏任务和微任务](./images/task.jpg)

::: tip 资料库 
* [如何解释Event Loop面试官才满意？- 知乎](https://zhuanlan.zhihu.com/p/72507900)
* [动图学 JavaScript 之：事件循环（Event Loop - 知乎](https://zhuanlan.zhihu.com/p/101165696)
:::